<!DOCTYPE html>
<html lang="cs">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Evidenƒçn√≠ syst√©m p≈Øjƒçovny</title>
      <script src="https://cdn.jsdelivr.net/npm/jsqr"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
			<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
			<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
			<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
			<link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
			<link rel="manifest" href="site.webmanifest">

	   
      <style> 
         body {
  font-family: Calibri, sans-serif;
  display: flex;
  justify-content: center;
  /* Jemn√© ≈°edob√≠l√© diagon√°ln√≠ ƒç√°ry na pozad√≠ */
  background-color: #f6f7fa;
  background-image: repeating-linear-gradient(
    135deg,
    #e9ecef 0px,
    #e9ecef 2px,
    transparent 2px,
    transparent 24px
  );
}
         h1 {text-align: center;}
         @keyframes fadeOutHighlight { 0% { background-color: #89CFF0; } 100% { background-color: white; } }
         .highlight { animation: fadeOutHighlight 10s forwards;}
         #deviceList {list-style-type: none; padding-left: 0; }
         #deviceList li {padding-left: 10px; }
         .device-id {font-size: 0.9em; color: #777; }
         button, .scan-button, .manage-device {
  transition: background 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.07);
}
button.loan:hover, .scan-button:hover {
  background: #218838;
}
button.return:hover {
  background: #c82333;
}
.manage-device:hover {
  background: #adb5bd;
}
         button {width: 100px; padding: 10px; margin: 5px; border: none; font-size: 16px; cursor: pointer; border-radius: 5px; }
         button.loan { background-color: #28a745; color: white; }
         button.return { background-color: #dc3545; color: white; }
         .container {max-width: 600px; width: 100%; padding: 20px; box-sizing: border-box;}
         .device-container { 
  display: flex; 
  flex-direction: column; 
  gap: 5px; 
  margin-bottom: 10px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 16px;
  margin-bottom: 18px;
  transition: box-shadow 0.2s;
}
.device-container:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.13);
}
         .device-header { display: flex; justify-content: space-between; font-weight: bold; width: 100%;}
         .device-name { font-weight: bold; text-align: left; flex: 1; }
         .device-status { 
  padding: 2px 12px;
  border-radius: 12px;
  font-size: 0.95em;
  background: #e9ecef;
  min-width: 80px;
  display: inline-block;
}
.device-status.available {
  background: #e6f9e7;
  color: #218838;
  border: 1px solid #b7e4c7;
}
.device-status.loaned {
  background: #ffe6e6;
  color: #c82333;
  border: 1px solid #f5c2c7;
}
         .device-details {display: flex; justify-content: space-between; width: 100%;}
         .device-details div {flex: 1;}
         .device-details span {white-space: nowrap;}
         .qr-code {max-width: 75px; height: auto; display: block; margin-left: 0; margin-right: auto;}
         .device-buttons {display: flex; justify-content: space-between; width: 100%;}
         .device-buttons button { width: 120px;}
         .device-status.available { color: green; }
         .device-status.loaned { color: red; }
         .manage-device { background-color: #ced4da; color: rgb(75, 75, 75); border: none; width: 30px; height: 30px; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 50%; text-align: center; transition: all 0.3s ease-in-out; margin-left: 10px; display: inline-flex; justify-content: center; align-items: center;}
	 #video {
  width: 0;
  height: 0;
  opacity: 0;
  transition: all 0.3s;
  object-fit: cover;
  border-radius: 10px;
  margin: 0 auto 10px auto;
  display: block;
}
#video.active {
  width: 300px;
  height: 300px;
  opacity: 1;
}
         .scan-buttons-container { display: flex; gap: 10px; justify-content: center;}
         .scan-button { background-color: #ced4da;color: black; border: none; font-size: 16px; cursor: pointer; border-radius: 5px; transition: all 0.3s ease-in-out; width: 150px; display: flex; align-items: center; justify-content: center; text-align: center; }
         
         #loanModal {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; }
         .modal-content { 
  background: #fafdff;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.13);
  padding: 28px 20px;
}
         .modal-content h2 { font-size: 1.5em; margin-bottom: 15px; text-align: center;}
         .modal-content label { font-weight: bold; margin-bottom: 5px; display: block;}
         .modal-content input { width: calc(100% - 20px); padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;}
         .modal-content button { padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;}
         .modal-content button[type="button"] { background: #adb5bd; margin-top: 10px;}
         body.modal-open { overflow: hidden;}
	      
	#scrollTopBtn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  display: none;
  background-color: #ced4da;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
  border-radius: 50%;
  text-align: center;
  transition: all 0.3s ease-in-out;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;           /* D≈ÆLE≈ΩIT√â: ≈æ√°dn√Ω padding */
  line-height: 1;       /* D≈ÆLE≈ΩIT√â: ≈æ√°dn√© svisl√© posunut√≠ */
  box-sizing: border-box;
}
	#scrollTopBtn:hover {background-color: #0056b3;}
	mark {background-color: yellow;}
        mark.current {background-color: orange;}
   	#searchModal {position: fixed; top: 20px; right: 20px; background: white; border: 1px solid #ccc; padding: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000;}
	      
	.modal-content input,
	#searchModal input {
  font-size: 16px;
}
	   
      </style>
   </head>
   <body>
   <div class="container">
      <!-- P≈ôid√°no logo -->
      <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
         <img src="logo.png" alt="Logo" style="max-width: 150px; width: 60vw; height: auto;">
      </div>
      <div class="header">
         <h1>Evidenƒçn√≠ syst√©m p≈Øjƒçovny</h1>
      </div>
      
      <div class="scan-buttons-container">
         <button class="scan-button" onclick="startScanner()">Spustit skener</button>
         <button class="scan-button" onclick="stopScanner()">Zastavit skener</button>
      </div>
      <video id="video" width="300" height="300" autoplay playsinline webkit-playsinline></video>
      <p id="scannerStatus"></p>
      <h2 style="display: inline-block;">Seznam za≈ô√≠zen√≠</h2> <br>
	 <button onclick="FindText()" class="manage-device">üîç</button>
<button onclick="showAddDeviceDialog()" class="manage-device">‚ûï</button>
<button onclick="showDeleteDeviceDialog()" class="manage-device">‚ûñ</button>
<button onclick="ExportDevice()" class="manage-device">QR</button>
<button onclick="ExportLoanHistory()" class="manage-device">üì§</button>
<button onclick="showHistoryModal()" class="manage-device">üìú</button> <!-- P≈ôid√°no tlaƒç√≠tko historie -->
         <ul id="deviceList"></ul>
      </div>

	<div id="searchModal" style="display:none;">
  		<input type="text" id="searchTerm" placeholder="Zadej hledan√Ω text">
  		<button onclick="nextMatch()">Dal≈°√≠</button>
  		<button onclick="closeSearch()">Zav≈ô√≠t</button>
	</div>
	   
	   
      <div id="loanModal" style="display:none;">
        <div class="modal-content">
          <h2>Formul√°≈ô pro p≈Øjƒçen√≠ za≈ô√≠zen√≠</h2>
          <form id="loanForm">
            <label for="loanedBy">P≈Øjƒçuj√≠c√≠:</label>
            <input type="text" id="loanedBy" placeholder="Zadejte sv√© jm√©no" required><br><br>

            <label for="loanedTo">Z√°kazn√≠k:</label>
            <input type="text" id="loanedTo" placeholder="Zadejte jm√©no z√°kazn√≠ka" required><br><br>

            <label for="company">Firma:</label>
            <input type="text" id="company" placeholder="Zadejte firmu z√°kazn√≠ka" required><br><br>

            <label for="phone">Telefon:</label>
            <input type="text" id="phone" placeholder="Zadejte telefon z√°kazn√≠ka" required><br><br>

            <label for="note">Pozn√°mka:</label>
            <input type="text" id="note" placeholder="Zadejte pozn√°mku"><br><br>

            <button type="submit">P≈Øjƒçit</button>
            <button type="button" id="cancelLoanButton">Zru≈°it</button>
          </form>
        </div>
      </div>

      <div id="historyModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:12px; max-width:95vw; max-height:90vh; overflow:auto; padding:24px 12px 12px 12px; position:relative;">
    <button onclick="closeHistoryModal()" style="position:absolute; top:8px; right:12px; background:#adb5bd; color:white; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; cursor:pointer;">√ó</button>
    <h2 style="margin-top:0;">Historie p≈Øjƒçek</h2>
    <div id="historyList"><em>Naƒç√≠t√°m...</em></div>
  </div>
</div>

<button id="scrollTopBtn">‚Üë</button>
								
<script type="module">
         import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
         import { getDatabase, ref, set, update, get, remove, push } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
         
         const firebaseConfig = {
         apiKey: "AIzaSyDff7I609AeT2bpdjIKewdAtzfPvOr8Hg4",
         authDomain: "test2-c4d26.firebaseapp.com",
         databaseURL: "https://test2-c4d26-default-rtdb.europe-west1.firebasedatabase.app",
         projectId: "test2-c4d26",
         storageBucket: "test2-c4d26.firebasestorage.app",
         messagingSenderId: "696702216457",
         appId: "1:696702216457:web:54cf142e7a63fcecb88bd8"
         };
         
         const app = initializeApp(firebaseConfig);
         const db = getDatabase(app);
         
         let scanning = false;
         let videoStream = null;
         
         // --- ZDE VLO≈Ω NOV√ù K√ìD ---
          window.showHistoryModal = function() {
            document.getElementById("historyModal").style.display = "flex";
            document.body.classList.add("modal-open");
            renderHistory();
          };

          window.closeHistoryModal = function() {
            document.getElementById("historyModal").style.display = "none";
            document.body.classList.remove("modal-open");
          };

          function renderHistory() {
            const historyDiv = document.getElementById("historyList");
            historyDiv.innerHTML = "<em>Naƒç√≠t√°m historii...</em>";
            const loanHistoryRef = ref(db, 'loanHistory/');
            get(loanHistoryRef).then((snapshot) => {
              if (snapshot.exists()) {
                const historyData = snapshot.val();
                // Se≈ôadit podle data p≈Øjƒçen√≠ (posledn√≠ naho≈ôe)
                const entries = Object.values(historyData).sort((a, b) => {
  // P≈ôevede datum ve form√°tu "DD.MM.RRRR" na ƒç√≠slo pro porovn√°n√≠
  const parseDate = (str) => {
    if (!str) return 0;
    const [d, m, y] = str.split(".");
    return new Date(`${y}-${m}-${d}`).getTime();
  };
  return parseDate(b.loanDate) - parseDate(a.loanDate);
});

                let html = `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.95em;">
                  <tr style="background:#f0f4fa;">
                    <th style="border:1px solid #ccc;padding:4px;">Za≈ô√≠zen√≠</th>
                    <th style="border:1px solid #ccc;padding:4px;">P≈Øjƒçuj√≠c√≠</th>
                    <th style="border:1px solid #ccc;padding:4px;">Z√°kazn√≠k</th>
                    <th style="border:1px solid #ccc;padding:4px;">P≈Øjƒçeno dne</th>
                    <th style="border:1px solid #ccc;padding:4px;">Firma</th>
                    <th style="border:1px solid #ccc;padding:4px;">Telefon</th>
                    <th style="border:1px solid #ccc;padding:4px;">Pozn√°mka</th>
                    <th style="border:1px solid #ccc;padding:4px;">Vr√°ceno dne</th>
                  </tr>`;
                for (const entry of entries) {
                  html += `<tr>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.name || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.loanedBy || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.loanedTo || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.loanDate || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.company || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.phone || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.note || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.returnDate || ""}</td>
                  </tr>`;
                }
                html += "</table></div>";
                historyDiv.innerHTML = html;
              } else {
                historyDiv.innerHTML = "<em>≈Ω√°dn√© z√°znamy v historii p≈Øjƒçek.</em>";
              }
            }).catch((error) => {
              historyDiv.innerHTML = "<em>Chyba p≈ôi naƒç√≠t√°n√≠ historie.</em>";
              console.error('Chyba p≈ôi z√≠sk√°v√°n√≠ historie p≈Øjƒçek:', error);
            });
          }
          // --- KONEC NOV√âHO K√ìDU ---

// ...n√°sleduje p≈Øvodn√≠ k√≥d, nap≈ô. renderDevices() atd.
         
         window.showAddDeviceDialog = function() {
         const deviceName = prompt("Zadejte n√°zev za≈ô√≠zen√≠:");
         if (deviceName) {
         addDevice(deviceName);
          }
         };
         
         window.addDevice = function(name) {
         if (!name) return;
         const newDeviceRef = ref(db, 'devices/' + Date.now());
         set(newDeviceRef, {
         name: name,
         status: "Dostupn√©",
         loanedBy: "",
         loanedTo: "",
         loanDate: "",
	       company: "",   
         phone: "",
         note: "" //POZNAMKA  
         }).then(() => {
         console.log("Za≈ô√≠zen√≠ bylo p≈ôid√°no");
         renderDevices();
         }).catch((error) => {
         console.error("Chyba p≈ôi p≈ôid√°v√°n√≠ za≈ô√≠zen√≠:", error);
         });
         };
         
         window.showDeleteDeviceDialog = function() {
         const deviceId = prompt("Zadejte ID za≈ô√≠zen√≠, kter√© chcete smazat:");
         if (deviceId) {
         deleteDevice(deviceId);
         }
         };
         
         window.deleteDevice = function(id) {
    if (!id) return;

    const deviceRef = ref(db, 'devices/' + id);

    get(deviceRef).then((snapshot) => {
        if (snapshot.exists()) {
            let newName = prompt("Zadejte nov√Ω n√°zev za≈ô√≠zen√≠:");
            let newNote = prompt("Zadejte pozn√°mku k za≈ô√≠zen√≠:", snapshot.val().note || "");
            if (newName) {
                set(deviceRef, {
                    name: newName,
                    status: "Dostupn√©",
                    loanedBy: "",
                    loanedTo: "",
                    loanDate: "",
                    company: "",
                    phone: "",
                    note: newNote // <-- P≈ôid√°no pole Pozn√°mka
                }).then(() => {
                    console.log("Za≈ô√≠zen√≠ bylo √∫spƒõ≈°nƒõ aktualizov√°no.");
                    renderDevices();
                }).catch((error) => {
                    console.error("Chyba p≈ôi aktualizaci za≈ô√≠zen√≠:", error);
                });
            } else {
                alert("N√°zev za≈ô√≠zen√≠ nesm√≠ b√Ωt pr√°zdn√Ω.");
            }
        } else {
            alert("Za≈ô√≠zen√≠ s t√≠mto ID neexistuje.");
        }
    }).catch((error) => {
        console.error("Chyba p≈ôi naƒç√≠t√°n√≠ za≈ô√≠zen√≠:", error);
    });
};
         
         
         
         function renderDevices() {
             const list = document.getElementById("deviceList");
             list.innerHTML = "";
             const devicesRef = ref(db, 'devices/');
             get(devicesRef).then((snapshot) => {
                 if (snapshot.exists()) {
                     const devices = snapshot.val();
                     Object.keys(devices).forEach((key) => {
                         const device = devices[key];
                         let li = document.createElement("li");

                         let statusClass = device.status === "Dostupn√©" ? "available" : "loaned";
                         let statusText = device.status === "Dostupn√©" ? "Dostupn√©" : "P≈Øjƒçeno";

                         li.setAttribute("data-device-id", key);

                         li.innerHTML = `
    <div class="device-container">
        <div class="device-header">
            <span class="device-name">${device.name}</span>
            <span class="device-status ${statusClass}">${statusText}</span>
        </div>
        <div class="device-details">
            <div>
                <span class="device-id">ID: ${key}</span><br>
                P≈Øjƒçuj√≠c√≠: ${device.loanedBy || "-"}<br>
                Z√°kazn√≠k: ${device.loanedTo || "-"}<br>
                Datum z√°p≈Øjƒçky: ${device.loanDate || "-"}<br>
                Firma: ${device.company || "-"}<br> 
                Telefon: ${device.phone || "-"}<br>
                Pozn√°mka: ${device.note || "-"}<br> <!-- P≈ôid√°no zobrazen√≠ pozn√°mky -->
            </div>
            <div id="qrcode-${key}" class="qr-code" style="margin-left: 0;"></div>
        </div>
        <div class="device-buttons">
            <button class="loan" onclick="loanDeviceButton('${key}')">P≈Øjƒçit</button>
            <button class="return" onclick="returnDevice('${key}')">Vr√°tit</button>
        </div>
    </div>
`;
                         list.appendChild(li);
                         new QRCode(document.getElementById(`qrcode-${key}`), {
                             text: key,
                             width: 75,
                             height: 75
                         });
                     });
                 } else {
                     console.log("≈Ω√°dn√° data k zobrazen√≠.");
                 }
             }).catch((error) => {
                 console.error("Chyba p≈ôi naƒç√≠t√°n√≠ za≈ô√≠zen√≠:", error);
             });
         }

         
         function highlightDevice(deviceId) {
         removeHighlight();
         const deviceElement = document.querySelector(`[data-device-id="${deviceId}"]`);
         if (deviceElement) {
         deviceElement.classList.add("highlight");
         deviceElement.scrollIntoView({ behavior: "smooth", block: "center" });
          setTimeout(() => { deviceElement.classList.remove("highlight"); }, 15000);
         }
         }
         
         function removeHighlight() {
         document.querySelectorAll(".highlight").forEach(el => {
         el.classList.remove("highlight");
         });
         }
         
         function saveScrollPosition() {
         sessionStorage.setItem("scrollPosition", window.scrollY);
         }
         
         function restoreScrollPosition() {
         const savedPosition = sessionStorage.getItem("scrollPosition");
         if (savedPosition !== null) {
         setTimeout(() => {
         window.scrollTo(0, parseInt(savedPosition, 10));
         }, 100); // Kr√°tk√© zpo≈ædƒõn√≠ pro zaji≈°tƒõn√≠ naƒçten√≠ obsahu
         }
         }

	window.loanDeviceButton = function(id) {
		openLoanModal(id); // Otev≈ôe mod√°ln√≠ okno s formul√°≈ôem
	};

					
// Funkce pro otev≈ôen√≠ mod√°ln√≠ho okna
        function openLoanModal(deviceId) {
          const modal = document.getElementById("loanModal");
          modal.style.display = "flex";
	  document.body.style.overflow = "hidden"; 
          const form = document.getElementById("loanForm");

          form.onsubmit = function(event) {
  event.preventDefault();
  const loanedBy = document.getElementById("loanedBy").value;
  const loanedTo = document.getElementById("loanedTo").value;
  const company = document.getElementById("company").value;
  const phone = document.getElementById("phone").value;
  const note = document.getElementById("note").value; // <-- p≈ôid√°no

  loanDevice(deviceId, loanedBy, loanedTo, company, phone, note); // p≈ôed√°no d√°l
};
        }

	
// Funkce pro zav≈ôen√≠ mod√°ln√≠ho okna
			function closeLoanModal() {
    				const modal = document.getElementById("loanModal");
   				modal.style.display = "none"; // Zav≈ôe mod√°ln√≠ okno
				document.body.style.overflow = "";
   				document.getElementById("loanForm").reset(); // Vyƒçist√≠ formul√°≈ô
			}
			document.getElementById("loanModal").querySelector('button[type="button"]').addEventListener('click', closeLoanModal);

// Funkce pro p≈Øjƒçen√≠ za≈ô√≠zen√≠ s nov√Ωmi √∫daji
        function loanDevice(id, loanedBy, loanedTo, company, phone, note) {
          saveScrollPosition();
          const deviceRef = ref(db, 'devices/' + id);
          get(deviceRef).then((snapshot) => {
            if (snapshot.exists()) {
              const deviceData = snapshot.val();
              const loanDate = new Date().toLocaleDateString("cs-CZ");
              update(deviceRef, {
                name: deviceData.name,
                status: "P≈Øjƒçeno",
                loanedBy,
                loanedTo,
                loanDate,
                company,
                phone,
                note // <-- ulo≈æ√≠ pozn√°mku
              }).then(() => {
                console.log("Za≈ô√≠zen√≠ bylo p≈Øjƒçeno");
                const loanHistoryRef = ref(db, 'loanHistory/');
                const newLoanRef = push(loanHistoryRef);
                set(newLoanRef, {
                  name: deviceData.name,
                  loanedBy,
                  loanedTo,
                  loanDate,
                  company,
                  phone,
                  note, // <-- ulo≈æ√≠ pozn√°mku i do historie
                  returnDate: ""
                }).then(() => {
                  console.log("P≈Øjƒçen√≠ bylo zaznamen√°no do historie");
                }).catch((error) => {
                  console.error("Chyba p≈ôi ukl√°d√°n√≠ do historie p≈Øjƒçek:", error);
                });
                renderDevices();
                restoreScrollPosition();
                setTimeout(() => highlightDevice(id), 50);
                closeLoanModal();
              }).catch((error) => {
                console.error("Chyba p≈ôi p≈Øjƒçov√°n√≠ za≈ô√≠zen√≠:", error);
              });
            }
          }).catch((error) => {
            console.error("Chyba p≈ôi naƒç√≠t√°n√≠ za≈ô√≠zen√≠:", error);
          });
        }
         
         window.returnDevice = function(id) {
             saveScrollPosition();
             const deviceRef = ref(db, 'devices/' + id);
             get(deviceRef).then((snapshot) => {
                 if (snapshot.exists()) {
                     const deviceData = snapshot.val();
                     update(deviceRef, {
                         name: deviceData.name,
                         status: "Dostupn√©",
                         loanedBy: "",  
                         loanedTo: "",  
                         loanDate: "",  
                         company: "",   
                         phone: ""   
                     }).then(() => {
                         console.log("Za≈ô√≠zen√≠ bylo vr√°ceno");
			// Nalezen√≠ odpov√≠daj√≠c√≠ho z√°znamu v 'loanHistory' pro vr√°cen√≠ za≈ô√≠zen√≠
			        const loanHistoryRef = ref(db, 'loanHistory/');
        
        			// Z√≠sk√°n√≠ v≈°ech z√°znam≈Ø z loanHistory a hled√°n√≠ odpov√≠daj√≠c√≠ho z√°znamu
			        get(loanHistoryRef).then((snapshot) => {
			          if (snapshot.exists()) {
			            const historyData = snapshot.val();

			            // Hled√°n√≠ odpov√≠daj√≠c√≠ho z√°znamu, kter√Ω m√° odpov√≠daj√≠c√≠ za≈ô√≠zen√≠
			            for (const key in historyData) {
			              if (historyData[key].name === deviceData.name && historyData[key].loanedTo === deviceData.loanedTo) {
			                // P≈ôid√°n√≠ data vr√°cen√≠ do p≈ô√≠slu≈°n√©ho z√°znamu
			                const loanEntryRef = ref(db, 'loanHistory/' + key);
			                const returnDate = new Date().toLocaleDateString("cs-CZ");

			                update(loanEntryRef, {
			                  returnDate
			                }).then(() => {
			                  console.log("Datum vr√°cen√≠ bylo p≈ôid√°no do historie");
			                }).catch((error) => {
			                  console.error("Chyba p≈ôi aktualizaci historie p≈Øjƒçek:", error);
			                });
			                break; // P≈ôeru≈°en√≠ smyƒçky po nalezen√≠ odpov√≠daj√≠c√≠ho z√°znamu
			              }
			            }
			          }
			        }).catch((error) => {
			          console.error("Chyba p≈ôi z√≠sk√°v√°n√≠ historie p≈Øjƒçek:", error);
			        });
			     
                         renderDevices();
                         restoreScrollPosition();
                         setTimeout(() => highlightDevice(id), 50);
                     }).catch((error) => {
                         console.error("Chyba p≈ôi vr√°cen√≠ za≈ô√≠zen√≠:", error);
                     });
                 }
             }).catch((error) => {
                 console.error("Chyba p≈ôi naƒç√≠t√°n√≠ za≈ô√≠zen√≠:", error);
             });
         };
         
         window.startScanner = function () {
             if (scanning) return;
             scanning = true;
             document.getElementById("scannerStatus").innerText = "Spou≈°t√≠m skener...";
             let video = document.getElementById("video");
             video.classList.add("active");

             navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                 .then(stream => {
                     videoStream = stream;
                     let video = document.getElementById("video");
                     video.srcObject = stream;
                     let canvas = document.createElement("canvas");
                     let ctx = canvas.getContext("2d");
                     document.getElementById("scannerStatus").innerText = "Skenov√°n√≠...";

                     function scan() {
                         if (!scanning) return;
                         if (video.readyState === video.HAVE_ENOUGH_DATA) {
                             canvas.width = video.videoWidth;
                             canvas.height = video.videoHeight;
                             ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                             let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                             let code = jsQR(imageData.data, canvas.width, canvas.height);

                             if (code) {
                                 console.log("Nalezen QR k√≥d:", code.data);
                                 document.getElementById("scannerStatus").innerText = "QR k√≥d naskenov√°n!";
                                 scanning = false;
                                 if (videoStream) {
                                     videoStream.getTracks().forEach(track => track.stop());
                                 }
                                 // Skryje video po naskenov√°n√≠
                                 let video = document.getElementById("video");
                                  video.classList.remove("active");
                                  video.srcObject = null;
                                 highlightDevice(code.data);
                                 return;
                             }
                         }
                         if (scanning) {
                             requestAnimationFrame(scan);
                }
                     }

                     scan();
                 })
                 .catch(err => {
                     console.warn("Kamera se nepoda≈ôila spustit, p≈ôep√≠n√°m na ƒçteƒçku.", err);
                     document.getElementById("scannerStatus").innerText = "Pou≈æijte ƒçteƒçku ƒç√°rov√Ωch k√≥d≈Ø...";
                     fallbackToKeyboardScanner();
                 });
         };

	 window.stopScanner = function () {
	     scanning = false;
	     if (videoStream) {
	         videoStream.getTracks().forEach(track => track.stop());
	     }
	     if (scannerListener) {
	         window.removeEventListener("keydown", scannerListener);
	         scannerListener = null;
	     }
	     document.getElementById("scannerStatus").innerText = "Skener zastaven.";

	     // OPRAVA: Skryj a vypr√°zdni video
	     let video = document.getElementById("video");
	     video.classList.remove("active");
	     video.srcObject = null;
	     video.removeAttribute("src"); // pro jistotu na nƒõkter√Ωch prohl√≠≈æeƒç√≠ch
	     video.load();

	     renderDevices();
	 };

	let scannerBuffer = "";
	let scannerListener;

	function fallbackToKeyboardScanner() {
  	  let input = document.getElementById("scannerInput");
	    if (!input) {
        	input = document.createElement("input");
	        input.id = "scannerInput";
        	input.type = "text";
	        input.style.position = "absolute";
        	input.style.opacity = "0";
	        input.style.height = "1px";
        	input.style.width = "1px";
	        input.autocomplete = "off";
        	document.body.appendChild(input);
	    }

	    input.value = "";
	    input.focus();

	    input.addEventListener("keydown", function onKeyDown(e) {
        	if (e.key === "Enter") {
	            const scannedCode = input.value.trim();

        	    // üëá P≈ôidej debug a validaci
	            console.log("Naskenov√°no z ƒçteƒçky:", JSON.stringify(scannedCode));

        	    // Vol√°n√≠ stejnƒõ jako u mobilu
	            document.getElementById("scannerStatus").innerText = "K√≥d naskenov√°n!";
        	    scanning = false;

	            highlightDevice(scannedCode);  // stejn√© jako p≈ôi skenu mobilem

        	    input.value = "";
	            input.blur();
        	    input.removeEventListener("keydown", onKeyDown);
	        }
	    });
	}

         
         window.ExportDevice = function() {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             const devicesRef = ref(db, 'devices/');
    
             get(devicesRef).then((snapshot) => {
                 if (!snapshot.exists()) {
                     alert("≈Ω√°dn√° za≈ô√≠zen√≠ k exportu.");
                     return;
                 }

                 const devices = snapshot.val();
                 const keys = Object.keys(devices);
                 const qrPromises = keys.map((key) => generateQRCode(key));

                 Promise.all(qrPromises).then((qrDataArray) => {
                     let x = 10, y = 10;
                     const qrSize = 25, spacing = 10;
                     const pageWidth = doc.internal.pageSize.width;
                     const pageHeight = doc.internal.pageSize.height;
                     let counter = 0; // Po≈ôadov√© ƒç√≠slo zaƒç√≠n√°me na 0

                     qrDataArray.forEach(({ key, imgData }) => {
                         doc.setFontSize(7);  // Nastav√≠ velikost p√≠sma na 8 bod≈Ø
                         doc.text(`${counter}. ID: ${key}`, x, y); // P≈ôid√°me po≈ôadov√© ƒç√≠slo p≈ôed ID
                         doc.addImage(imgData, "PNG", x, y+1, qrSize, qrSize);

                         x += qrSize + spacing;
                         if (x + qrSize > pageWidth - 10) {
                             x = 10;
                             y += qrSize + spacing;
                         }
                         if (y + qrSize > pageHeight - 10) {
                             doc.addPage();
                             x = 10;
                             y = 10;
                         }

                         counter++; // Inkrementace ƒç√≠taƒçe pro dal≈°√≠ QR k√≥d
                     });

                     doc.save("QR_kody.pdf");
                 });
             }).catch((error) => {
                 console.error("Chyba p≈ôi naƒç√≠t√°n√≠ za≈ô√≠zen√≠:", error);
             });
         };
         
         function generateQRCode(key) {
             return new Promise((resolve) => {
                 const tempDiv = document.createElement("div");
                 document.body.appendChild(tempDiv);
                 const qr = new QRCode(tempDiv, { text: key, width: 128, height: 128 });
         
                 setTimeout(() => {
                     const img = tempDiv.querySelector("img");
                     const imgData = img ? img.src : null;
                     document.body.removeChild(tempDiv);
                     resolve({ key, imgData });
                 }, 300);
             });
         }
         
         window.ExportLoanHistory = function() {
             const loanHistoryRef = ref(db, 'loanHistory/');
             get(loanHistoryRef).then((snapshot) => {
                 if (snapshot.exists()) {
                     const historyData = snapshot.val();
                     let csvContent = "Za≈ô√≠zen√≠;P≈Øjƒçuj√≠c√≠;Z√°kazn√≠k;P≈Øjƒçeno dne;Firma;Telefon;Pozn√°mka;Vr√°ceno dne\n";
                     for (const key in historyData) {
                         const entry = historyData[key];
                         const name = entry.name || '';
                         const loanedBy = entry.loanedBy || '';
                         const loanedTo = entry.loanedTo || '';
                         const loanDate = entry.loanDate || '';
                         const company = entry.company || '';
                         const phone = entry.phone ? `'${entry.phone}` : '';
                         const note = entry.note || '';
                         const returnDate = entry.returnDate || '';
                         csvContent += `"${name}";"${loanedBy}";"${loanedTo}";"${loanDate}";"${company}";"${phone}";"${note}";"${returnDate}"\n`;
                     }
                     const BOM = "\uFEFF";  
                     const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8;" });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement("a");
                     a.href = url;
                     a.download = "loan_history.csv";
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                 } else {
                     console.log('≈Ω√°dn√© z√°znamy v historii p≈Øjƒçek.');
                 }
             }).catch((error) => {
                 console.error('Chyba p≈ôi z√≠sk√°v√°n√≠ historie p≈Øjƒçek:', error);
             });
         }
        
         window.addEventListener("beforeunload", function() {
         saveScrollPosition();
         });
         window.onload = function() {
         restoreScrollPosition();
         renderDevices();
         setTimeout(restoreScrollPosition, 100);
         };

	document.addEventListener("DOMContentLoaded", function () {
   	 let scrollTopBtn = document.getElementById("scrollTopBtn");

  	  window.addEventListener("scroll", function () {
  	      if (window.scrollY > 2500) {
 	           scrollTopBtn.style.display = "block";
 	       } else {
 	           scrollTopBtn.style.display = "none";
 	       }
 	   });

 	   scrollTopBtn.addEventListener("click", function () {
   	     window.scrollTo({ top: 0, behavior: "smooth" });
 	   });
	});

         window.matches = [];
         window.currentIndex = -1;
         window.lastSearchTerm = "";

         window.FindText = function () {
           document.getElementById('searchModal').style.display = 'block';
           document.getElementById('searchTerm').focus();
         };

         window.closeSearch = function () {
           document.getElementById('searchModal').style.display = 'none';
           clearSearchMarks();
           window.matches = [];
           window.currentIndex = -1;
           window.lastSearchTerm = "";
         };

         // Odstran√≠ v≈°echny <mark> tagy (zv√Ωraznƒõn√≠)
         function clearSearchMarks() {
           const marks = document.querySelectorAll('mark');
           marks.forEach(mark => {
             const text = document.createTextNode(mark.textContent);
             mark.replaceWith(text);
           });
         }

         // Z√≠sk√° v≈°echny textov√© uzly kromƒõ modal okna
         function getTextNodes(node) {
           let nodes = [];
           if (node.nodeType === Node.TEXT_NODE) {
             nodes.push(node);
           } else {
             for (let child of node.childNodes) {
               if (!(child.id && child.id === "searchModal")) {
                 nodes = nodes.concat(getTextNodes(child));
               }
             }
           }
           return nodes;
         }

         // Provede zv√Ωraznƒõn√≠ v√Ωskyt≈Ø
         function markSearchMatches(term) {
           clearSearchMarks();
           window.matches = [];

           const nodes = getTextNodes(document.body);
           const regex = new RegExp(term, 'gi');

           nodes.forEach(node => {
             const parent = node.parentNode;
             const text = node.textContent;
             let match;
             let lastIndex = 0;
             regex.lastIndex = 0;

             if (!regex.test(text)) return;

             regex.lastIndex = 0;
             const frag = document.createDocumentFragment();

             while ((match = regex.exec(text)) !== null) {
               if (match.index > lastIndex) {
                 frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
               }
               const mark = document.createElement('mark');
               mark.textContent = match[0];
               frag.appendChild(mark);
               window.matches.push(mark);
               lastIndex = match.index + match[0].length;
             }

             if (lastIndex < text.length) {
               frag.appendChild(document.createTextNode(text.slice(lastIndex)));
             }

             parent.replaceChild(frag, node);
           });

           window.currentIndex = -1;
         }

         // Posun na dal≈°√≠ v√Ωskyt
         window.nextMatch = function () {
           const term = document.getElementById('searchTerm').value.trim();
           if (!term) return;

           if (term !== window.lastSearchTerm) {
             markSearchMatches(term);
             window.lastSearchTerm = term;
           }

           if (window.matches.length === 0) return;

           window.matches.forEach(m => m.classList.remove('current'));
           window.currentIndex = (window.currentIndex + 1) % window.matches.length;
           const current = window.matches[window.currentIndex];
           current.classList.add('current');
           current.scrollIntoView({ behavior: 'smooth', block: 'center' });
         };

	
      </script>
   </body>
</html>
