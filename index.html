<!DOCTYPE html>
<html lang="cs">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>ESL∙Evidenční systém půjčovny</title>
      <script src="https://cdn.jsdelivr.net/npm/jsqr"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<<<<<<< HEAD
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
			<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
			<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
			<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
			<link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
			<link rel="manifest" href="site.webmanifest">

	   
      <style> 
         body {
  font-family: Calibri, sans-serif;
  display: flex;
  justify-content: center;
  /* Jemné šedobílé diagonální čáry na pozadí */
  background-color: #f6f7fa;
  background-image: repeating-linear-gradient(
    135deg,
    #e9ecef 0px,
    #e9ecef 2px,
    transparent 2px,
    transparent 24px
  );
}
         h1 {text-align: center;}
         @keyframes fadeOutHighlight { 0% { background-color: #89CFF0; } 100% { background-color: white; } }
         .highlight { animation: fadeOutHighlight 10s forwards;}
         #deviceList {list-style-type: none; padding-left: 0; }
         #deviceList li {padding-left: 10px; }
         .device-id {font-size: 0.9em; color: #777; }
         button, .scan-button, .manage-device {
  transition: background 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.07);
}
button.loan:hover, .scan-button:hover {
  background: #218838;
}
button.return:hover {
  background: #c82333;
}
.manage-device:hover {
  background: #adb5bd;
}
         button {width: 100px; padding: 10px; margin: 5px; border: none; font-size: 16px; cursor: pointer; border-radius: 5px; }
         button.loan { background-color: #28a745; color: white; }
         button.return { background-color: #dc3545; color: white; }
         .container {max-width: 600px; width: 100%; padding: 20px; box-sizing: border-box;}
         .device-container { 
  display: flex; 
  flex-direction: column; 
  gap: 5px; 
  margin-bottom: 10px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 16px;
  margin-bottom: 18px;
  transition: box-shadow 0.2s;
}
.device-container:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.13);
}
         .device-header { display: flex; justify-content: space-between; font-weight: bold; width: 100%;}
         .device-name { font-weight: bold; text-align: left; flex: 1; }
         .device-status { 
  padding: 2px 12px;
  border-radius: 12px;
  font-size: 0.95em;
  background: #e9ecef;
  min-width: 80px;
  display: inline-block;
}
.device-status.available {
  background: #e6f9e7;
  color: #218838;
  border: 1px solid #b7e4c7;
}
.device-status.loaned {
  background: #ffe6e6;
  color: #c82333;
  border: 1px solid #f5c2c7;
}
         .device-details {display: flex; justify-content: space-between; width: 100%;}
         .device-details div {flex: 1;}
         .device-details span {white-space: nowrap;}
         .qr-code {max-width: 75px; height: auto; display: block; margin-left: 0; margin-right: auto;}
         .device-buttons {display: flex; justify-content: space-between; width: 100%;}
         .device-buttons button { width: 120px;}
         .device-status.available { color: green; }
         .device-status.loaned { color: red; }
         .manage-device { background-color: #ced4da; color: rgb(75, 75, 75); border: none; width: 30px; height: 30px; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 50%; text-align: center; transition: all 0.3s ease-in-out; margin-left: 10px; display: inline-flex; justify-content: center; align-items: center;}
	 #video {
  width: 0;
  height: 0;
  opacity: 0;
  transition: all 0.3s;
  object-fit: cover;
  border-radius: 10px;
  margin: 0 auto 10px auto;
  display: block;
}
#video.active {
  width: 300px;
  height: 300px;
  opacity: 1;
}
         .scan-buttons-container { display: flex; gap: 10px; justify-content: center;}
         .scan-button { background-color: #ced4da;color: black; border: none; font-size: 16px; cursor: pointer; border-radius: 5px; transition: all 0.3s ease-in-out; width: 150px; display: flex; align-items: center; justify-content: center; text-align: center; }
         
         #loanModal {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; }
         .modal-content { 
  background: #fafdff;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.13);
  padding: 28px 20px;
}
         .modal-content h2 { font-size: 1.5em; margin-bottom: 15px; text-align: center;}
         .modal-content label { font-weight: bold; margin-bottom: 5px; display: block;}
         .modal-content input { width: calc(100% - 20px); padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;}
         .modal-content button { padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;}
         .modal-content button[type="button"] { background: #adb5bd; margin-top: 10px;}
         body.modal-open { overflow: hidden;}
	      
	#scrollTopBtn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  display: none;
  background-color: #ced4da;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
  border-radius: 50%;
  text-align: center;
  transition: all 0.3s ease-in-out;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;           /* DŮLEŽITÉ: žádný padding */
  line-height: 1;       /* DŮLEŽITÉ: žádné svislé posunutí */
  box-sizing: border-box;
}
	#scrollTopBtn:hover {background-color: #0056b3;}
	mark {background-color: yellow;}
        mark.current {background-color: orange;}
   	#searchModal {position: fixed; top: 20px; right: 20px; background: white; border: 1px solid #ccc; padding: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000;}
	      
	.modal-content input,
	#searchModal input {
  font-size: 16px;
}

	/* Styling pro QR export modal */
	#qrExportModal {
	  position: fixed; 
	  top: 0; 
	  left: 0; 
	  width: 100%; 
	  height: 100%; 
	  background: rgba(0, 0, 0, 0.5); 
	  display: none; 
	  justify-content: center; 
	  align-items: center; 
	  z-index: 1000; 
	  overflow-y: auto;
	}
	
	.qr-export-content {
	  background: #fafdff;
	  border-radius: 12px;
	  box-shadow: 0 4px 24px rgba(0,0,0,0.13);
	  padding: 20px;
	  max-width: 500px;
	  max-height: 80vh;
	  overflow-y: auto;
	  width: 90%;
	}
	
	.device-checkbox {
	  display: flex;
	  align-items: center;
	  margin: 8px 0;
	  padding: 8px;
	  border: 1px solid #e9ecef;
	  border-radius: 5px;
	  background: #f8f9fa;
	}
	
	.device-checkbox input[type="checkbox"] {
	  margin-right: 10px;
	  transform: scale(1.2);
	}
	
	.device-checkbox label {
	  flex: 1;
	  cursor: pointer;
	  font-weight: normal;
	}
	
	.select-buttons {
	  display: flex;
	  gap: 10px;
	  margin: 15px 0;
	}
	
	.select-buttons button {
	  padding: 8px 16px;
	  background: #6c757d;
	  color: white;
	  border: none;
	  border-radius: 5px;
	  cursor: pointer;
	  font-size: 14px;
	}
	
	.select-buttons button:hover {
	  background: #5a6268;
	}
	
	.scroll-down-btn {
	  position: absolute;
	  bottom: 80px;
	  right: 20px;
	  background: #007bff;
	  color: white;
	  border: none;
	  width: 40px;
	  height: 40px;
	  border-radius: 50%;
	  cursor: pointer;
	  font-size: 18px;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
	  transition: all 0.3s ease;
	  z-index: 10;
	}
	
	.scroll-down-btn:hover {
	  background: #0056b3;
	  transform: scale(1.1);
	}
	
	.scroll-up-btn {
	  position: absolute;
	  bottom: 130px;
	  right: 20px;
	  background: #28a745;
	  color: white;
	  border: none;
	  width: 40px;
	  height: 40px;
	  border-radius: 50%;
	  cursor: pointer;
	  font-size: 18px;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
	  transition: all 0.3s ease;
	  z-index: 10;
	}
	
	.scroll-up-btn:hover {
	  background: #218838;
	  transform: scale(1.1);
	}
<<<<<<< HEAD

	/* Styling pro Metrics modal */
	#metricsModal {
	  position: fixed; 
	  top: 0; 
	  left: 0; 
	  width: 100%; 
	  height: 100%; 
	  background: rgba(0, 0, 0, 0.5); 
	  display: none; 
	  justify-content: center; 
	  align-items: flex-start; 
	  z-index: 2000; 
	  overflow-y: auto;
	  padding: 10px 0;
	}

	.metrics-content {
	  background: #fafdff;
	  border-radius: 12px;
	  box-shadow: 0 4px 24px rgba(0,0,0,0.13);
	  padding: 24px;
	  width: 900px;
	  max-width: 95vw;
	  height: 95vh;
	  max-height: 95vh;
	  overflow-y: auto;
	  position: relative;
	  margin: 0 auto;
	}

	.metrics-dashboard {
	  display: grid;
	  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	  gap: 15px;
	  margin: 20px 0;
	}

	.metric-card {
	  background: #f8f9fa;
	  padding: 20px;
	  border-radius: 8px;
	  text-align: center;
	  border-left: 4px solid #007bff;
	}

	.metric-value {
	  font-size: 2em;
	  font-weight: bold;
	  color: #007bff;
	  margin: 10px 0;
	}

	.metric-label {
	  font-size: 0.9em;
	  color: #6c757d;
	  text-transform: uppercase;
	  font-weight: 500;
	}

	.chart-container {
	  display: grid;
	  grid-template-columns: 1fr 1fr;
	  gap: 20px;
	  margin: 20px 0;
	}

	.chart-box {
	  background: #fff;
	  padding: 20px;
	  border-radius: 8px;
	  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	  height: 250px;
	  display: flex;
	  flex-direction: column;
	}

	.chart-title {
	  font-size: 1.1em;
	  font-weight: bold;
	  margin-bottom: 15px;
	  text-align: center;
	  color: #495057;
	  flex-shrink: 0;
	}

	.chart-box canvas {
	  flex: 1;
	  max-height: 200px !important;
	  width: 100% !important;
	}

	.top-devices {
	  background: #fff;
	  padding: 20px;
	  border-radius: 8px;
	  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	  margin: 20px 0;
	}

	.top-device-item {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  padding: 8px 0;
	  border-bottom: 1px solid #e9ecef;
	}

	.top-device-item:last-child {
	  border-bottom: none;
	}

	.device-name {
	  font-weight: 500;
	}

	.device-count {
	  background: #007bff;
	  color: white;
	  padding: 2px 8px;
	  border-radius: 12px;
	  font-size: 0.8em;
	}

	.trend-up { color: #28a745; }
	.trend-down { color: #dc3545; }
	.trend-neutral { color: #6c757d; }

	@media (max-width: 768px) {
	  .chart-container {
	    grid-template-columns: 1fr;
	  }
	  
	  .metrics-dashboard {
	    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
	  }
	}
=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
	   
      </style>
   </head>
   <body>
   <div class="container">
      <!-- Přidáno logo -->
      <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
         <img src="logo.png" alt="Logo" style="max-width: 150px; width: 60vw; height: auto;">
      </div>
      <div class="header">
         <h1>Evidenční systém půjčovny</h1>
      </div>
      
      <div class="scan-buttons-container">
         <button class="scan-button" onclick="startScanner()">Spustit skener</button>
         <button class="scan-button" onclick="stopScanner()">Zastavit skener</button>
      </div>
      <video id="video" width="300" height="300" autoplay playsinline webkit-playsinline></video>
      <p id="scannerStatus"></p>
      <h2 style="display: inline-block;">Seznam zařízení</h2> <br>
	 <button onclick="FindText()" class="manage-device">🔍</button>
<button onclick="showAddDeviceDialog()" class="manage-device">➕</button>
<button onclick="showDeleteDeviceDialog()" class="manage-device">➖</button>
<button onclick="showQRExportModal()" class="manage-device">QR</button>
<button onclick="ExportLoanHistory()" class="manage-device">📤</button>
<<<<<<< HEAD
<button onclick="showHistoryModal()" class="manage-device">📜</button>
<button onclick="showMetricsModal()" class="manage-device">📊</button> <!-- Přidáno tlačítko historie -->
=======
<button onclick="showHistoryModal()" class="manage-device">📜</button> <!-- Přidáno tlačítko historie -->
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
         <ul id="deviceList"></ul>
      </div>

	<div id="searchModal" style="display:none;">
  		<input type="text" id="searchTerm" placeholder="Zadej hledaný text">
  		<button onclick="nextMatch()">Další</button>
  		<button onclick="closeSearch()">Zavřít</button>
	</div>
<<<<<<< HEAD

=======
	   
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
	   
      <div id="loanModal" style="display:none;">
        <div class="modal-content">
          <h2>Formulář pro půjčení zařízení</h2>
          <form id="loanForm">
            <label for="loanedBy">Půjčující:</label>
            <input type="text" id="loanedBy" placeholder="Zadejte své jméno" required><br><br>

            <label for="loanedTo">Zákazník:</label>
            <input type="text" id="loanedTo" placeholder="Zadejte jméno zákazníka" required><br><br>

            <label for="company">Firma:</label>
            <input type="text" id="company" placeholder="Zadejte firmu zákazníka" required><br><br>

            <label for="phone">Telefon:</label>
            <input type="text" id="phone" placeholder="Zadejte telefon zákazníka" required><br><br>

            <label for="note">Poznámka:</label>
            <input type="text" id="note" placeholder="Zadejte poznámku"><br><br>

            <button type="submit">Půjčit</button>
            <button type="button" id="cancelLoanButton">Zrušit</button>
          </form>
        </div>
      </div>

      <div id="historyModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:12px; max-width:95vw; max-height:90vh; overflow:auto; padding:24px 12px 12px 12px; position:relative;">
    <button onclick="closeHistoryModal()" style="
  position:absolute;
  top:8px;
  right:12px;
  background:#adb5bd;
  color:white;
  border:none;
  border-radius:50%;
  width:32px;
  height:32px;
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
  line-height:1;
">✖️</button>
    <h2 style="margin-top:0;">Historie půjček</h2>
    <div id="historyList"><em>Načítám...</em></div>
  </div>
</div>

      <!-- QR Export Modal -->
      <div id="qrExportModal">
        <div class="qr-export-content">
          <h2>Výběr zařízení pro export QR kódů</h2>
          <div class="select-buttons">
            <button onclick="selectAllDevices()">Vybrat vše</button>
            <button onclick="deselectAllDevices()">Zrušit výběr</button>
          </div>
          <div id="deviceCheckboxList">
            <!-- Zde se dynamicky vygenerují checkboxy -->
          </div>
          <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="exportSelectedQRCodes()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; flex: 1;">
              Exportovat vybrané
            </button>
            <button onclick="closeQRExportModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
              Zrušit
            </button>
          </div>
          <!-- Scroll tlačítka -->
          <button class="scroll-up-btn" onclick="scrollToTop()" title="Scroll nahoru">↑</button>
          <button class="scroll-down-btn" onclick="scrollToBottom()" title="Scroll dolů">↓</button>
        </div>
      </div>

<<<<<<< HEAD
      <!-- Metrics Modal -->
      <div id="metricsModal">
        <div class="metrics-content">
          <button onclick="closeMetricsModal()" style="position:absolute; top:12px; right:16px; background:#adb5bd; color:white; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; line-height:1;">✖️</button>
          
          <h2 style="margin-top:0; text-align:center; color:#495057;">📊 Metriky a statistiky</h2>
          
          <div class="metrics-dashboard" id="metricsCards">
            <!-- Zde se dynamicky vygenerují karty metrik -->
          </div>
          
          <div class="chart-container">
            <div class="chart-box">
              <div class="chart-title">Využití zařízení</div>
              <canvas id="utilizationChart" width="300" height="200"></canvas>
            </div>
            <div class="chart-box">
              <div class="chart-title">Trend půjček (30 dní)</div>
              <canvas id="trendChart" width="300" height="200"></canvas>
            </div>
          </div>
          
          <div class="top-devices">
            <div class="chart-title">Nejpůjčovanější zařízení</div>
            <div id="topDevicesList">
              <!-- Zde se dynamicky vygeneruje seznam -->
            </div>
          </div>
          
          <div style="margin-top: 20px; text-align: center;">
            <button onclick="closeMetricsModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
              Zavřít
            </button>
          </div>
        </div>
      </div>

=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
<button id="scrollTopBtn">↑</button>
								
<script type="module">
         import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
         import { getDatabase, ref, set, update, get, remove, push } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
         
         const firebaseConfig = {
         apiKey: "AIzaSyDff7I609AeT2bpdjIKewdAtzfPvOr8Hg4",
         authDomain: "test2-c4d26.firebaseapp.com",
         databaseURL: "https://test2-c4d26-default-rtdb.europe-west1.firebasedatabase.app",
         projectId: "test2-c4d26",
         storageBucket: "test2-c4d26.firebasestorage.app",
         messagingSenderId: "696702216457",
         appId: "1:696702216457:web:54cf142e7a63fcecb88bd8"
         };
         
         const app = initializeApp(firebaseConfig);
         const db = getDatabase(app);
         
         let scanning = false;
         let videoStream = null;
         
         // --- ZDE VLOŽ NOVÝ KÓD ---
          window.showHistoryModal = function() {
            document.getElementById("historyModal").style.display = "flex";
            document.body.classList.add("modal-open");
            renderHistory();
<<<<<<< HEAD
            
            // Jednoduchý event listener pro ESC
            function handleEscKey(event) {
              if (event.key === 'Escape') {
                closeHistoryModal();
              }
            }
            
            // Event listener pro kliknutí mimo modal
            function handleClickOutside(event) {
              const modal = document.getElementById("historyModal");
              const modalContent = modal.querySelector('div[style*="background:#fff"]');
              if (event.target === modal && !modalContent.contains(event.target)) {
                closeHistoryModal();
              }
            }
            
            // Přidání event listenerů
            document.addEventListener('keydown', handleEscKey);
            document.addEventListener('click', handleClickOutside);
            
            // Uložení referencí pro pozdější odstranění
            window.historyModalEscListener = handleEscKey;
            window.historyModalClickListener = handleClickOutside;
=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
          };

          window.closeHistoryModal = function() {
            document.getElementById("historyModal").style.display = "none";
            document.body.classList.remove("modal-open");
<<<<<<< HEAD
            
            // Odstranění event listenerů
            if (window.historyModalEscListener) {
              document.removeEventListener('keydown', window.historyModalEscListener);
              window.historyModalEscListener = null;
            }
            if (window.historyModalClickListener) {
              document.removeEventListener('click', window.historyModalClickListener);
              window.historyModalClickListener = null;
            }
=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
          };

          function renderHistory() {
            const historyDiv = document.getElementById("historyList");
            historyDiv.innerHTML = "<em>Načítám historii...</em>";
            const loanHistoryRef = ref(db, 'loanHistory/');
            get(loanHistoryRef).then((snapshot) => {
              if (snapshot.exists()) {
                const historyData = snapshot.val();
                // Seřadit podle data půjčení (poslední nahoře)
                const entries = Object.values(historyData).sort((a, b) => {
  // Převede datum ve formátu "DD.MM.RRRR" na číslo pro porovnání
  const parseDate = (str) => {
    if (!str) return 0;
    const [d, m, y] = str.split(".");
    return new Date(`${y}-${m}-${d}`).getTime();
  };
  return parseDate(b.loanDate) - parseDate(a.loanDate);
});

                let html = `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.95em;">
                  <tr style="background:#f0f4fa;">
                    <th style="border:1px solid #ccc;padding:4px;">Zařízení</th>
                    <th style="border:1px solid #ccc;padding:4px;">Půjčující</th>
                    <th style="border:1px solid #ccc;padding:4px;">Zákazník</th>
                    <th style="border:1px solid #ccc;padding:4px;">Půjčeno dne</th>
                    <th style="border:1px solid #ccc;padding:4px;">Firma</th>
                    <th style="border:1px solid #ccc;padding:4px;">Telefon</th>
                    <th style="border:1px solid #ccc;padding:4px;">Poznámka</th>
                    <th style="border:1px solid #ccc;padding:4px;">Vráceno dne</th>
                  </tr>`;
                for (const entry of entries) {
                  html += `<tr>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.name || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.loanedBy || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.loanedTo || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.loanDate || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.company || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.phone || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.note || ""}</td>
                    <td style="border:1px solid #ccc;padding:4px;">${entry.returnDate || ""}</td>
                  </tr>`;
                }
                html += "</table></div>";
                historyDiv.innerHTML = html;
              } else {
                historyDiv.innerHTML = "<em>Žádné záznamy v historii půjček.</em>";
              }
            }).catch((error) => {
              historyDiv.innerHTML = "<em>Chyba při načítání historie.</em>";
              console.error('Chyba při získávání historie půjček:', error);
            });
          }
          // --- KONEC NOVÉHO KÓDU ---

// ...následuje původní kód, např. renderDevices() atd.
         
         window.showAddDeviceDialog = function() {
         const deviceName = prompt("Zadejte název zařízení:");
         if (deviceName) {
         addDevice(deviceName);
          }
         };
         
         window.addDevice = function(name) {
         if (!name) return;
         const newDeviceRef = ref(db, 'devices/' + Date.now());
         set(newDeviceRef, {
         name: name,
         status: "Dostupné",
         loanedBy: "",
         loanedTo: "",
         loanDate: "",
	       company: "",   
         phone: "",
         note: "" //POZNAMKA  
         }).then(() => {
         console.log("Zařízení bylo přidáno");
         renderDevices();
         }).catch((error) => {
         console.error("Chyba při přidávání zařízení:", error);
         });
         };
         
         window.showDeleteDeviceDialog = function() {
         const deviceId = prompt("Zadejte ID zařízení, které chcete smazat:");
         if (deviceId) {
         deleteDevice(deviceId);
         }
         };
         
         window.deleteDevice = function(id) {
    if (!id) return;

    const deviceRef = ref(db, 'devices/' + id);

    get(deviceRef).then((snapshot) => {
        if (snapshot.exists()) {
<<<<<<< HEAD
            const currentDevice = snapshot.val();
            const oldName = currentDevice.name;
            let newName = prompt("Zadejte nový název zařízení:");
            
            if (newName) {
                // Aktualizace zařízení
=======
            let newName = prompt("Zadejte nový název zařízení:");
            //let newNote = prompt("Zadejte poznámku k zařízení:", snapshot.val().note || "");
            if (newName) {
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
                set(deviceRef, {
                    name: newName,
                    status: "Dostupné",
                    loanedBy: "",
                    loanedTo: "",
                    loanDate: "",
                    company: "",
                    phone: "",
<<<<<<< HEAD
                    note: ""
                }).then(() => {
                    console.log("Zařízení bylo úspěšně aktualizováno.");
                    
                    // Aktualizace historie půjček - změna názvu ve všech záznamech
                    const loanHistoryRef = ref(db, 'loanHistory/');
                    get(loanHistoryRef).then((historySnapshot) => {
                        if (historySnapshot.exists()) {
                            const historyData = historySnapshot.val();
                            const updates = {};
                            
                            // Projdi všechny záznamy historie a aktualizuj názvy
                            Object.keys(historyData).forEach(historyKey => {
                                if (historyData[historyKey].name === oldName) {
                                    updates[`loanHistory/${historyKey}/name`] = newName;
                                }
                            });
                            
                            // Provedení hromadné aktualizace
                            if (Object.keys(updates).length > 0) {
                                update(ref(db), updates).then(() => {
                                    console.log("Historie půjček byla aktualizována.");
                                    renderDevices();
                                }).catch((error) => {
                                    console.error("Chyba při aktualizaci historie:", error);
                                    renderDevices();
                                });
                            } else {
                                renderDevices();
                            }
                        } else {
                            renderDevices();
                        }
                    }).catch((error) => {
                        console.error("Chyba při načítání historie:", error);
                        renderDevices();
                    });
=======
                    note: "" // <-- Přidáno pole Poznámka
                }).then(() => {
                    console.log("Zařízení bylo úspěšně aktualizováno.");
                    renderDevices();
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
                }).catch((error) => {
                    console.error("Chyba při aktualizaci zařízení:", error);
                });
            } else {
                alert("Název zařízení nesmí být prázdný.");
            }
        } else {
            alert("Zařízení s tímto ID neexistuje.");
        }
    }).catch((error) => {
        console.error("Chyba při načítání zařízení:", error);
    });
};
         
         
         
         function renderDevices() {
             const list = document.getElementById("deviceList");
             list.innerHTML = "";
             const devicesRef = ref(db, 'devices/');
             get(devicesRef).then((snapshot) => {
                 if (snapshot.exists()) {
                     const devices = snapshot.val();
                     Object.keys(devices).forEach((key) => {
                         const device = devices[key];
                         let li = document.createElement("li");

                         let statusClass = device.status === "Dostupné" ? "available" : "loaned";
                         let statusText = device.status === "Dostupné" ? "Dostupné" : "Půjčeno";

                         li.setAttribute("data-device-id", key);

                         li.innerHTML = `
    <div class="device-container">
        <div class="device-header">
            <span class="device-name">${device.name}</span>
            <span class="device-status ${statusClass}">${statusText}</span>
        </div>
        <div class="device-details">
            <div>
                <span class="device-id">ID: ${key}</span><br>
                Půjčující: ${device.loanedBy || "-"}<br>
                Zákazník: ${device.loanedTo || "-"}<br>
                Datum zápůjčky: ${device.loanDate || "-"}<br>
                Firma: ${device.company || "-"}<br> 
                Telefon: ${device.phone || "-"}<br>
                Poznámka: ${device.note || "-"}<br> <!-- Přidáno zobrazení poznámky -->
            </div>
            <div id="qrcode-${key}" class="qr-code" style="margin-left: 0;"></div>
        </div>
        <div class="device-buttons">
            <button class="loan" onclick="loanDeviceButton('${key}')">Půjčit</button>
            <button class="return" onclick="returnDevice('${key}')">Vrátit</button>
        </div>
    </div>
`;
                         list.appendChild(li);
                         new QRCode(document.getElementById(`qrcode-${key}`), {
                             text: key,
                             width: 75,
                             height: 75
                         });
                     });
                 } else {
                     console.log("Žádná data k zobrazení.");
                 }
             }).catch((error) => {
                 console.error("Chyba při načítání zařízení:", error);
             });
         }

         
         function highlightDevice(deviceId) {
    removeHighlight();
    const deviceElement = document.querySelector(`[data-device-id="${deviceId}"]`);
    if (deviceElement) {
        // Najdi .device-container uvnitř li
        const container = deviceElement.querySelector('.device-container');
        if (container) {
            container.classList.add("highlight");
            container.scrollIntoView({ behavior: "smooth", block: "center" });
            setTimeout(() => { container.classList.remove("highlight"); }, 1500);
        } else {
            // fallback, kdyby nebyl .device-container
            deviceElement.classList.add("highlight");
            deviceElement.scrollIntoView({ behavior: "smooth", block: "center" });
            setTimeout(() => { deviceElement.classList.remove("highlight"); }, 1500);
        }
    }
}
         
         function removeHighlight() {
         document.querySelectorAll(".highlight").forEach(el => {
         el.classList.remove("highlight");
         });
         }
         
         function saveScrollPosition() {
         sessionStorage.setItem("scrollPosition", window.scrollY);
         }
         
         function restoreScrollPosition() {
         const savedPosition = sessionStorage.getItem("scrollPosition");
         if (savedPosition !== null) {
         setTimeout(() => {
         window.scrollTo(0, parseInt(savedPosition, 10));
         }, 100); // Krátké zpoždění pro zajištění načtení obsahu
         }
         }

	window.loanDeviceButton = function(id) {
		openLoanModal(id); // Otevře modální okno s formulářem
	};

					
// Funkce pro otevření modálního okna
        function openLoanModal(deviceId) {
          const modal = document.getElementById("loanModal");
          modal.style.display = "flex";
	  document.body.style.overflow = "hidden"; 
          const form = document.getElementById("loanForm");

          form.onsubmit = function(event) {
  event.preventDefault();
  const loanedBy = document.getElementById("loanedBy").value;
  const loanedTo = document.getElementById("loanedTo").value;
  const company = document.getElementById("company").value;
  const phone = document.getElementById("phone").value;
  const note = document.getElementById("note").value; // <-- přidáno

  loanDevice(deviceId, loanedBy, loanedTo, company, phone, note); // předáno dál
};
        }

	
// Funkce pro zavření modálního okna
			function closeLoanModal() {
    				const modal = document.getElementById("loanModal");
   				modal.style.display = "none"; // Zavře modální okno
				document.body.style.overflow = "";
   				document.getElementById("loanForm").reset(); // Vyčistí formulář
			}
			document.getElementById("loanModal").querySelector('button[type="button"]').addEventListener('click', closeLoanModal);

// Funkce pro půjčení zařízení s novými údaji
        function loanDevice(id, loanedBy, loanedTo, company, phone, note) {
          saveScrollPosition();
          const deviceRef = ref(db, 'devices/' + id);
          get(deviceRef).then((snapshot) => {
            if (snapshot.exists()) {
              const deviceData = snapshot.val();
              const loanDate = new Date().toLocaleDateString("cs-CZ");
              update(deviceRef, {
                name: deviceData.name,
                status: "Půjčeno",
                loanedBy,
                loanedTo,
                loanDate,
                company,
                phone,
                note // <-- uloží poznámku
              }).then(() => {
                console.log("Zařízení bylo půjčeno");
                const loanHistoryRef = ref(db, 'loanHistory/');
                const newLoanRef = push(loanHistoryRef);
                set(newLoanRef, {
                  name: deviceData.name,
                  loanedBy,
                  loanedTo,
                  loanDate,
                  company,
                  phone,
                  note, // <-- uloží poznámku i do historie
                  returnDate: ""
                }).then(() => {
                  console.log("Půjčení bylo zaznamenáno do historie");
                }).catch((error) => {
                  console.error("Chyba při ukládání do historie půjček:", error);
                });
                renderDevices();
                restoreScrollPosition();
                setTimeout(() => {
                  highlightDevice(id);
                  const deviceElement = document.querySelector(`[data-device-id="${id}"]`);
                  if (deviceElement) {
                    const container = deviceElement.querySelector('.device-container');
                    if (container) {
                      container.classList.add('highlight');
                      setTimeout(() => container.classList.remove('highlight'), 3000);
                    }
                  }
                }, 300); // <-- zvýšeno z 50 na 300 ms
                closeLoanModal();
              }).catch((error) => {
                console.error("Chyba při půjčování zařízení:", error);
              });
            }
          }).catch((error) => {
            console.error("Chyba při načítání zařízení:", error);
          });
        }
         
         window.returnDevice = function(id) {
    saveScrollPosition();
    const deviceRef = ref(db, 'devices/' + id);
    get(deviceRef).then((snapshot) => {
        if (snapshot.exists()) {
            const deviceData = snapshot.val();
            update(deviceRef, {
                name: deviceData.name,
                status: "Dostupné",
                loanedBy: "",  
                loanedTo: "",  
                loanDate: "",  
                company: "",   
                phone: "",
                note: "" // <-- SMAŽE POZNÁMKU PŘI VRÁCENÍ
            }).then(() => {
                console.log("Zařízení bylo vráceno");
                // Nalezení odpovídajícího záznamu v 'loanHistory' pro vrácení zařízení
                const loanHistoryRef = ref(db, 'loanHistory/');
                // Získání všech záznamů z loanHistory a hledání odpovídajícího záznamu
                get(loanHistoryRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const historyData = snapshot.val();
                        // Hledání odpovídajícího záznamu, který má odpovídající zařízení
                        for (const key in historyData) {
                            if (historyData[key].name === deviceData.name && historyData[key].loanedTo === deviceData.loanedTo) {
                                // Přidání data vrácení do příslušného záznamu
                                const loanEntryRef = ref(db, 'loanHistory/' + key);
                                const returnDate = new Date().toLocaleDateString("cs-CZ");
                                update(loanEntryRef, {
                                    returnDate
                                }).then(() => {
                                    console.log("Datum vrácení bylo přidáno do historie");
                                }).catch((error) => {
                                    console.error("Chyba při aktualizaci historie půjček:", error);
                                });
                                break; // Přerušení smyčky po nalezení odpovídajícího záznamu
                            }
                        }
                    }
                }).catch((error) => {
                    console.error("Chyba při získávání historie půjček:", error);
                });

                renderDevices();
                restoreScrollPosition();
                setTimeout(() => {
                    highlightDevice(id);
                    const deviceElement = document.querySelector(`[data-device-id="${id}"]`);
                    if (deviceElement) {
                        const container = deviceElement.querySelector('.device-container');
                        if (container) {
                            container.classList.add('highlight');
                            setTimeout(() => container.classList.remove('highlight'), 3000);
                        }
                    }
                }, 300);
            }).catch((error) => {
                console.error("Chyba při vrácení zařízení:", error);
            });
        }
    }).catch((error) => {
        console.error("Chyba při načítání zařízení:", error);
    });
};
         
         window.startScanner = function () {
             if (scanning) return;
             scanning = true;
             document.getElementById("scannerStatus").innerText = "Spouštím skener...";
             let video = document.getElementById("video");
             video.classList.add("active");

             navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                 .then(stream => {
                     videoStream = stream;
                     let video = document.getElementById("video");
                     video.srcObject = stream;
                     let canvas = document.createElement("canvas");
                     let ctx = canvas.getContext("2d");
                     document.getElementById("scannerStatus").innerText = "Skenování...";

                     function scan() {
                         if (!scanning) return;
                         if (video.readyState === video.HAVE_ENOUGH_DATA) {
                             canvas.width = video.videoWidth;
                             canvas.height = video.videoHeight;
                             ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                             let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                             let code = jsQR(imageData.data, canvas.width, canvas.height);

                             if (code) {
                                 console.log("Nalezen QR kód:", code.data);
                                 document.getElementById("scannerStatus").innerText = "QR kód naskenován!";
                                 scanning = false;
                                 if (videoStream) {
                                     videoStream.getTracks().forEach(track => track.stop());
                                 }
                                 let video = document.getElementById("video");
                                 video.classList.remove("active");
                                 video.srcObject = null;
                                 // Nejprve načti zařízení a pak zvýrazni
                                 renderDevices();
                                 setTimeout(() => highlightDevice(code.data), 100);
                                 return;
                             }
                         }
                         if (scanning) {
                             requestAnimationFrame(scan);
                }
                     }

                     scan();
                 })
                 .catch(err => {
                     console.warn("Kamera se nepodařila spustit, přepínám na čtečku.", err);
                     document.getElementById("scannerStatus").innerText = "Použijte čtečku čárových kódů...";
                     fallbackToKeyboardScanner();
                 });
         };

	 window.stopScanner = function () {
	     scanning = false;
	     if (videoStream) {
	         videoStream.getTracks().forEach(track => track.stop());
	     }
	     if (scannerListener) {
	         window.removeEventListener("keydown", scannerListener);
	         scannerListener = null;
	     }
	     document.getElementById("scannerStatus").innerText = "Skener zastaven.";

	     // OPRAVA: Skryj a vyprázdni video
	     let video = document.getElementById("video");
	     video.classList.remove("active");
	     video.srcObject = null;
	     video.removeAttribute("src"); // pro jistotu na některých prohlížečích
	     video.load();

	     renderDevices();
	 };

	let scannerBuffer = "";
	let scannerListener;

	function fallbackToKeyboardScanner() {
  	  let input = document.getElementById("scannerInput");
	    if (!input) {
        	input = document.createElement("input");
	        input.id = "scannerInput";
        	input.type = "text";
	        input.style.position = "absolute";
        	input.style.opacity = "0";
	        input.style.height = "1px";
        	input.style.width = "1px";
	        input.autocomplete = "off";
        	document.body.appendChild(input);
	    }

	    input.value = "";
	    input.focus();

	    input.addEventListener("keydown", function onKeyDown(e) {
        	if (e.key === "Enter") {
	            const scannedCode = input.value.trim();

        	    // 👇 Přidej debug a validaci
	            console.log("Naskenováno z čtečky:", JSON.stringify(scannedCode));

        	    // Volání stejně jako u mobilu
	            document.getElementById("scannerStatus").innerText = "Kód naskenován!";
        	    scanning = false;

	            highlightDevice(scannedCode);  // stejné jako při skenu mobilem

        	    input.value = "";
	            input.blur();
        	    input.removeEventListener("keydown", onKeyDown);
	        }
	    });
	}

         
<<<<<<< HEAD
         // Metrics Modal functions
         let utilizationChart = null;
         let trendChart = null;
         
         window.showMetricsModal = function() {
           // Ochrana proti vícenásobnému otevření
           if (window.metricsModalOpen) {
             return;
           }
           window.metricsModalOpen = true;
           
           const modal = document.getElementById("metricsModal");
           modal.style.display = "flex";
           document.body.classList.add("modal-open");
           
           // Načtení dat a vykreslení metrik pouze jednou
           if (!window.metricsLoaded) {
             loadMetricsData();
             window.metricsLoaded = true;
           }
           
           // Event listenery pro ESC a kliknutí mimo
           function handleEscKey(event) {
             if (event.key === 'Escape') {
               closeMetricsModal();
             }
           }
           
           function handleClickOutside(event) {
             const modalContent = document.querySelector('.metrics-content');
             if (event.target === modal && !modalContent.contains(event.target)) {
               closeMetricsModal();
             }
           }
           
           document.addEventListener('keydown', handleEscKey);
           document.addEventListener('click', handleClickOutside);
           
           modal.keyPressHandler = handleEscKey;
           modal.clickOutsideHandler = handleClickOutside;
         };

         window.closeMetricsModal = function() {
           const modal = document.getElementById("metricsModal");
           modal.style.display = "none";
           document.body.classList.remove("modal-open");
           
           // Reset všech flag
           window.metricsLoading = false;
           window.renderingCharts = false;
           window.metricsModalOpen = false;
           window.metricsLoaded = false;
           
           // Zničení grafů
           if (utilizationChart) {
             utilizationChart.destroy();
             utilizationChart = null;
           }
           if (trendChart) {
             trendChart.destroy();
             trendChart = null;
           }
           
           // Odstranění event listenerů
           if (modal.keyPressHandler) {
             document.removeEventListener('keydown', modal.keyPressHandler);
             modal.keyPressHandler = null;
           }
           if (modal.clickOutsideHandler) {
             document.removeEventListener('click', modal.clickOutsideHandler);
             modal.clickOutsideHandler = null;
           }
         };

         function loadMetricsData() {
           // Kontrola, zda už se data nenačítají nebo už jsou načtená
           if (window.metricsLoading || window.metricsLoaded) {
             return;
           }
           
           window.metricsLoading = true;
           
           // Načtení zařízení a historie současně
           Promise.all([
             get(ref(db, 'devices/')),
             get(ref(db, 'loanHistory/'))
           ]).then(([devicesSnapshot, historySnapshot]) => {
             const devices = devicesSnapshot.exists() ? devicesSnapshot.val() : {};
             const history = historySnapshot.exists() ? historySnapshot.val() : {};
             
             const metrics = calculateMetrics(devices, history);
             renderMetrics(metrics);
             
             // Renderování grafů pouze jednou
             setTimeout(() => {
               renderCharts(metrics);
             }, 100);
             
             window.metricsLoading = false;
           }).catch((error) => {
             console.error("Chyba při načítání dat pro metriky:", error);
             window.metricsLoading = false;
           });
         }

         function calculateMetrics(devices, history) {
           const devicesArray = Object.values(devices);
           const historyArray = Object.values(history);
           
           // Základní metriky
           const totalDevices = devicesArray.length;
           const availableDevices = devicesArray.filter(d => d.status === 'Dostupné').length;
           const loanedDevices = devicesArray.filter(d => d.status === 'Půjčeno').length;
           const utilizationRate = totalDevices > 0 ? ((loanedDevices / totalDevices) * 100).toFixed(1) : 0;
           
           // Trendy za posledních 30 dní
           const last30Days = [];
           const today = new Date();
           for (let i = 29; i >= 0; i--) {
             const date = new Date(today);
             date.setDate(date.getDate() - i);
             last30Days.push({
               date: date.toLocaleDateString('cs-CZ'),
               count: 0
             });
           }
           
           // Počítání půjček za jednotlivé dny
           historyArray.forEach(entry => {
             if (entry.loanDate) {
               const loanDate = entry.loanDate;
               const dayIndex = last30Days.findIndex(day => day.date === loanDate);
               if (dayIndex !== -1) {
                 last30Days[dayIndex].count++;
               }
             }
           });
           
           // Nejpůjčovanější zařízení
           const deviceCounts = {};
           historyArray.forEach(entry => {
             if (entry.name) {
               deviceCounts[entry.name] = (deviceCounts[entry.name] || 0) + 1;
             }
           });
           
           const topDevices = Object.entries(deviceCounts)
             .sort((a, b) => b[1] - a[1])
             .slice(0, 5);
           
           // Statistiky za posledních 30 dní
           const thirtyDaysAgo = new Date();
           thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
           
           const recentLoans = historyArray.filter(entry => {
             if (!entry.loanDate) return false;
             const [day, month, year] = entry.loanDate.split('.');
             const loanDate = new Date(year, month - 1, day);
             return loanDate >= thirtyDaysAgo;
           });
           
           const monthlyLoans = recentLoans.length;
           const avgLoansPerDay = (monthlyLoans / 30).toFixed(1);
           
           return {
             totalDevices,
             availableDevices,
             loanedDevices,
             utilizationRate,
             monthlyLoans,
             avgLoansPerDay,
             last30Days,
             topDevices
           };
         }

         function renderMetrics(metrics) {
           const cardsContainer = document.getElementById('metricsCards');
           cardsContainer.innerHTML = `
             <div class="metric-card">
               <div class="metric-label">Celkem zařízení</div>
               <div class="metric-value">${metrics.totalDevices}</div>
             </div>
             <div class="metric-card">
               <div class="metric-label">Dostupné</div>
               <div class="metric-value" style="color: #28a745;">${metrics.availableDevices}</div>
             </div>
             <div class="metric-card">
               <div class="metric-label">Půjčeno</div>
               <div class="metric-value" style="color: #dc3545;">${metrics.loanedDevices}</div>
             </div>
             <div class="metric-card">
               <div class="metric-label">Půjčky (30 dní)</div>
               <div class="metric-value">${metrics.monthlyLoans}</div>
             </div>
           `;
           
           // Top zařízení
           const topDevicesContainer = document.getElementById('topDevicesList');
           if (metrics.topDevices.length > 0) {
             topDevicesContainer.innerHTML = metrics.topDevices.map(([name, count]) => `
               <div class="top-device-item">
                 <span class="device-name">${name}</span>
                 <span class="device-count">${count}x</span>
               </div>
             `).join('');
           } else {
             topDevicesContainer.innerHTML = '<div style="text-align: center; color: #6c757d;">Žádná data k zobrazení</div>';
           }
         }

         function renderCharts(metrics) {
           // Ochrana proti vícenásobnému volání
           if (window.renderingCharts) {
             return;
           }
           window.renderingCharts = true;
           
           // Zničení existujících grafů před vykreslením nových
           if (utilizationChart) {
             utilizationChart.destroy();
             utilizationChart = null;
           }
           if (trendChart) {
             trendChart.destroy();
             trendChart = null;
           }

           // Graf využití (koláčový)
           const utilizationCanvas = document.getElementById('utilizationChart');
           if (utilizationCanvas) {
             // Vymazání předchozího obsahu a nastavení rozměrů
             utilizationCanvas.width = 300;
             utilizationCanvas.height = 200;
             utilizationCanvas.style.width = '100%';
             utilizationCanvas.style.height = '200px';
             
             const utilizationCtx = utilizationCanvas.getContext('2d');
             utilizationChart = new Chart(utilizationCtx, {
               type: 'doughnut',
               data: {
                 labels: ['Dostupné', 'Půjčeno'],
                 datasets: [{
                   data: [metrics.availableDevices, metrics.loanedDevices],
                   backgroundColor: ['#28a745', '#dc3545'],
                   borderWidth: 2,
                   borderColor: '#fff'
                 }]
               },
               options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 animation: {
                   duration: 1000
                 },
                 plugins: {
                   legend: {
                     position: 'bottom'
                   }
                 }
               }
             });
           }

           // Graf trendů (čárový)
           const trendCanvas = document.getElementById('trendChart');
           if (trendCanvas) {
             // Vymazání předchozího obsahu a nastavení rozměrů
             trendCanvas.width = 300;
             trendCanvas.height = 200;
             trendCanvas.style.width = '100%';
             trendCanvas.style.height = '200px';
             
             const trendCtx = trendCanvas.getContext('2d');
             trendChart = new Chart(trendCtx, {
               type: 'line',
               data: {
                 labels: metrics.last30Days.map(day => {
                   const [day_num, month, year] = day.date.split('.');
                   return `${day_num}.${month}`;
                 }),
                 datasets: [{
                   label: 'Počet půjček',
                   data: metrics.last30Days.map(day => day.count),
                   borderColor: '#007bff',
                   backgroundColor: 'rgba(0, 123, 255, 0.1)',
                   fill: true,
                   tension: 0.4
                 }]
               },
               options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 animation: {
                   duration: 1000
                 },
                 scales: {
                   y: {
                     beginAtZero: true,
                     ticks: {
                       stepSize: 1
                     }
                   }
                 },
                 plugins: {
                   legend: {
                     display: false
                   }
                 }
               }
             });
           }
           
           // Uvolnění blokace renderování
           window.renderingCharts = false;
         }

=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
         // QR Export Modal functions
         window.showQRExportModal = function() {
           const modal = document.getElementById("qrExportModal");
           const checkboxList = document.getElementById("deviceCheckboxList");
           
           // Načtení zařízení z databáze
           const devicesRef = ref(db, 'devices/');
           get(devicesRef).then((snapshot) => {
             if (snapshot.exists()) {
               const devices = snapshot.val();
               let html = '';
               
               Object.keys(devices).forEach((key) => {
                 const device = devices[key];
                 const statusText = device.status === "Dostupné" ? "Dostupné" : "Půjčeno";
                 html += `
                   <div class="device-checkbox">
                     <input type="checkbox" id="device_${key}" value="${key}" checked>
                     <label for="device_${key}">
                       <strong>${device.name}</strong> - ${statusText}
                       <br><small style="color: #666;">ID: ${key}</small>
                     </label>
                   </div>
                 `;
               });
               
               checkboxList.innerHTML = html;
               modal.style.display = "flex";
               document.body.classList.add("modal-open");
               
               // Nastavení scrollu na začátek modálu
               const modalContent = document.querySelector('.qr-export-content');
               if (modalContent) {
                 modalContent.scrollTop = 0;
               }
               
               // Přidání event listenerů pro klávesové zkratky
               function handleKeyPress(event) {
                 if (event.key === 'Escape') {
                   closeQRExportModal();
                 } else if (event.key === 'Enter') {
                   exportSelectedQRCodes();
                 }
               }
               
               // Přidání event listeneru pro kliknutí mimo modal
               function handleClickOutside(event) {
                 const modalContent = document.querySelector('.qr-export-content');
                 if (modal.style.display === 'flex' && !modalContent.contains(event.target)) {
                   closeQRExportModal();
                 }
               }
               
               // Přidání event listenerů
               document.addEventListener('keydown', handleKeyPress);
               document.addEventListener('click', handleClickOutside);
               
               // Uložení referencí pro pozdější odstranění
               modal.keyPressHandler = handleKeyPress;
               modal.clickOutsideHandler = handleClickOutside;
             } else {
               alert("Žádná zařízení k exportu.");
             }
           }).catch((error) => {
             console.error("Chyba při načítání zařízení:", error);
             alert("Chyba při načítání zařízení.");
           });
         };

         window.closeQRExportModal = function() {
           const modal = document.getElementById("qrExportModal");
           modal.style.display = "none";
           document.body.classList.remove("modal-open");
           
           // Odstranění event listenerů
           if (modal.keyPressHandler) {
             document.removeEventListener('keydown', modal.keyPressHandler);
             modal.keyPressHandler = null;
           }
           if (modal.clickOutsideHandler) {
             document.removeEventListener('click', modal.clickOutsideHandler);
             modal.clickOutsideHandler = null;
           }
         };

         window.selectAllDevices = function() {
           const checkboxes = document.querySelectorAll('#deviceCheckboxList input[type="checkbox"]');
           checkboxes.forEach(checkbox => {
             checkbox.checked = true;
           });
         };

         window.deselectAllDevices = function() {
           const checkboxes = document.querySelectorAll('#deviceCheckboxList input[type="checkbox"]');
           checkboxes.forEach(checkbox => {
             checkbox.checked = false;
           });
         };

         window.exportSelectedQRCodes = function() {
           const checkboxes = document.querySelectorAll('#deviceCheckboxList input[type="checkbox"]:checked');
           const selectedDevices = Array.from(checkboxes).map(cb => cb.value);
           
           if (selectedDevices.length === 0) {
             alert("Prosím vyberte alespoň jedno zařízení pro export.");
             return;
           }
           
           // Zavřít modal
           closeQRExportModal();
           
           // Exportovat vybrané QR kódy
           exportQRCodes(selectedDevices);
         };

         window.scrollToBottom = function() {
           const modal = document.querySelector('.qr-export-content');
           modal.scrollTo({
             top: modal.scrollHeight,
             behavior: 'smooth'
           });
         };

         window.scrollToTop = function() {
           const modal = document.querySelector('.qr-export-content');
           modal.scrollTo({
             top: 0,
             behavior: 'smooth'
           });
         };

         function exportQRCodes(deviceIds) {
           const { jsPDF } = window.jspdf;
           const doc = new jsPDF();
           
           // URL obrázku loga
           const logoURL = "https://raw.githubusercontent.com/TyhoNex/EvidencniSystemPujcovny/refs/heads/main/logo.png";
           
           // Funkce pro načtení loga z URL
           function loadLogoFromURL() {
             return new Promise((resolve) => {
               const img = new Image();
               img.crossOrigin = "anonymous"; // Důležité pro CORS
               
               img.onload = function() {
                 console.log("Logo úspěšně načteno z URL");
                 // Převedeme obrázek na canvas a pak na base64
                 const canvas = document.createElement('canvas');
                 const ctx = canvas.getContext('2d');
                 canvas.width = img.width;
                 canvas.height = img.height;
                 ctx.drawImage(img, 0, 0);
                 
                 try {
                   const dataURL = canvas.toDataURL('image/png');
                   console.log("Logo převedeno na base64, délka:", dataURL.length);
                   resolve(dataURL);
                 } catch(e) {
                   console.error("Chyba při převodu na base64:", e);
                   resolve(null);
                 }
               };
               
               img.onerror = function() {
                 console.error("Chyba při načítání loga z URL - zkouším fetch");
                 // Záložní metoda s fetch
                 fetch(logoURL)
                   .then(response => response.blob())
                   .then(blob => {
                     const reader = new FileReader();
                     reader.onload = function() {
                       console.log("Logo načteno pomocí fetch");
                       resolve(reader.result);
                     };
                     reader.onerror = function() {
                       console.error("Fetch metoda také selhala");
                       resolve(null);
                     };
                     reader.readAsDataURL(blob);
                   })
                   .catch(err => {
                     console.error("Fetch chyba:", err);
                     resolve(null);
                   });
               };
               
               img.src = logoURL;
             });
           }
           
           const qrPromises = deviceIds.map((deviceId) => generateQRCode(deviceId));

           // Načteme logo a QR kódy současně
           Promise.all([loadLogoFromURL(), ...qrPromises]).then((results) => {
             const logoDataURL = results[0]; // První výsledek je logo
             const qrDataArray = results.slice(1); // Zbytek jsou QR kódy
             
             console.log("Logo pro PDF:", logoDataURL ? "načteno" : "není k dispozici");
             
             let x = 0, y = 0;
             const itemWidth = 55, itemHeight = 75, spacingX = -2.5, spacingY = -4.25;
             const pageWidth = doc.internal.pageSize.width;
             const pageHeight = doc.internal.pageSize.height;
             let counter = 0;

             qrDataArray.forEach(({ key, imgData }) => {
               // Pro 4x4 layout - nová stránka po každých 16 položkách
               if (counter > 0 && counter % 16 === 0) {
                 doc.addPage();
                 x = 0;
                 y = 0;
               }
<<<<<<< HEAD
=======

>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
               // Šířka oblasti pro číslo a logo (stejná jako QR kód)
               const qrWidth = itemWidth - 20; // 35mm
               const qrStartX = x + 2;
               const qrStartY = y + 2;

               // 1. Číslo vlevo v oblasti QR kódu
               doc.setFontSize(36);
               doc.setFont("helvetica", "bold");
               doc.text(`${counter}`, qrStartX, qrStartY + 18, { align: 'left' });

               // 2. Logo vpravo v oblasti QR kódu (pokud je k dispozici)
               if (logoDataURL) {
                 try {
                   console.log("Vkládám logo pro item", counter);
                   // Logo umístíme do pravé části oblasti QR kódu
                   const logoWidth = qrWidth * 0.6; // 60% šířky QR oblasti
                   const logoHeight = 12; // Zmenšená výška pro lepší proporce
                   const logoX = qrStartX + qrWidth - logoWidth;
                   doc.addImage(logoDataURL, "PNG", logoX, qrStartY + 8, logoWidth, logoHeight);
                 } catch(e) {
                   console.error("Chyba při vkládání loga do PDF:", e);
                   // Fallback text vpravo v oblasti QR kódu
                   doc.setFontSize(10);
                   doc.setFont("helvetica", "bold");
                   doc.text("ESL", qrStartX + qrWidth - 10, qrStartY + 10, { align: 'right' });
                   doc.setFontSize(8);
                   doc.setFont("helvetica", "normal");
                   doc.text("technická zařízení budov", qrStartX + qrWidth - 10, qrStartY + 16, { align: 'right' });
                 }
               } else {
                 console.log("Logo není k dispozici pro item", counter, "- používám text");
                 // Pokud není logo, zobrazíme název firmy vpravo v oblasti QR kódu
                 doc.setFontSize(10);
                 doc.setFont("helvetica", "bold");
                 doc.text("ESL", qrStartX + qrWidth - 10, qrStartY + 10, { align: 'right' });
                 doc.setFontSize(8);
                 doc.setFont("helvetica", "normal");
                 doc.text("technická zařízení budov", qrStartX + qrWidth - 10, qrStartY + 16, { align: 'right' });
               }

               // 3. ID pod číslem a logem (uprostřed QR oblasti)
               doc.setFontSize(8);
               doc.setFont("helvetica", "normal");
               doc.text(`${counter} | ID: ${key}`, qrStartX + qrWidth/2, qrStartY + 26, { align: 'center' });

               // 4. QR kód dole pod celým obsahem (používá stejnou šířku)
               if (imgData) {
                 doc.addImage(imgData, "PNG", qrStartX, qrStartY + 30, qrWidth, qrWidth);
               }

               // Posun na další pozici
               x += itemWidth + spacingX;
               // Pro 4x4 layout - po 4 položkách přejdi na nový řádek
               if ((counter + 1) % 4 === 0) {
                 x = 0;
                 y += itemHeight + spacingY;
               }

               counter++;
             });

             doc.save("QR_kody_vyber.pdf");
             console.log("PDF vygenerováno s", counter, "QR kódy, logo:", logoDataURL ? "vloženo" : "nebylo k dispozici");
           }).catch((error) => {
             console.error("Chyba při generování QR kódů:", error);
             alert("Chyba při generování PDF.");
           });
         }
         

         window.ExportDevice = function() {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             const devicesRef = ref(db, 'devices/');
    
             get(devicesRef).then((snapshot) => {
                 if (!snapshot.exists()) {
                     alert("Žádná zařízení k exportu.");
                     return;
                 }

                 const devices = snapshot.val();
                 const keys = Object.keys(devices);
                 
                 // Použijeme novou funkci exportQRCodes pro všechna zařízení
                 exportQRCodes(keys);
             }).catch((error) => {
                 console.error("Chyba při načítání zařízení:", error);
             });
         };
         
         function generateQRCode(key) {
             return new Promise((resolve) => {
                 const tempDiv = document.createElement("div");
                 document.body.appendChild(tempDiv);
                 const qr = new QRCode(tempDiv, { text: key, width: 128, height: 128 });
         
                 setTimeout(() => {
                     const img = tempDiv.querySelector("img");
                     const imgData = img ? img.src : null;
                     document.body.removeChild(tempDiv);
                     resolve({ key, imgData });
                 }, 300);
             });
         }
         
         window.ExportLoanHistory = function() {
             const loanHistoryRef = ref(db, 'loanHistory/');
             get(loanHistoryRef).then((snapshot) => {
                 if (snapshot.exists()) {
                     const historyData = snapshot.val();
                     let csvContent = "Zařízení;Půjčující;Zákazník;Půjčeno dne;Firma;Telefon;Poznámka;Vráceno dne\n";
                     for (const key in historyData) {
                         const entry = historyData[key];
                         const name = entry.name || '';
                         const loanedBy = entry.loanedBy || '';
                         const loanedTo = entry.loanedTo || '';
                         const loanDate = entry.loanDate || '';
                         const company = entry.company || '';
                         const phone = entry.phone ? `'${entry.phone}` : '';
                         const note = entry.note || '';
                         const returnDate = entry.returnDate || '';
                         csvContent += `"${name}";"${loanedBy}";"${loanedTo}";"${loanDate}";"${company}";"${phone}";"${note}";"${returnDate}"\n`;
                     }
                     const BOM = "\uFEFF";  
                     const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8;" });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement("a");
                     a.href = url;
                     a.download = "loan_history.csv";
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                 } else {
                     console.log('Žádné záznamy v historii půjček.');
                 }
             }).catch((error) => {
                 console.error('Chyba při získávání historie půjček:', error);
             });
         }
        
         window.addEventListener("beforeunload", function() {
         saveScrollPosition();
         });
         window.onload = function() {
         restoreScrollPosition();
         renderDevices();
         setTimeout(restoreScrollPosition, 100);
         };

	document.addEventListener("DOMContentLoaded", function () {
   	 let scrollTopBtn = document.getElementById("scrollTopBtn");

  	  window.addEventListener("scroll", function () {
  	      if (window.scrollY > 2500) {
 	           scrollTopBtn.style.display = "block";
 	       } else {
 	           scrollTopBtn.style.display = "none";
 	       }
 	   });

 	   scrollTopBtn.addEventListener("click", function () {
   	     window.scrollTo({ top: 0, behavior: "smooth" });
 	   });
	});

         window.matches = [];
         window.currentIndex = -1;
         window.lastSearchTerm = "";

         window.FindText = function () {
           document.getElementById('searchModal').style.display = 'block';
           document.getElementById('searchTerm').focus();
<<<<<<< HEAD
           
           // Event listener pro ESC klávesy
           function handleEscKey(event) {
             if (event.key === 'Escape') {
               closeSearch();
             }
           }
           
           // Přidání event listeneru
           document.addEventListener('keydown', handleEscKey);
           
           // Uložení reference pro pozdější odstranění
           window.searchModalEscListener = handleEscKey;
=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
         };

         window.closeSearch = function () {
           document.getElementById('searchModal').style.display = 'none';
           clearSearchMarks();
           window.matches = [];
           window.currentIndex = -1;
           window.lastSearchTerm = "";
<<<<<<< HEAD
           
           // Odstranění event listeneru pro ESC
           if (window.searchModalEscListener) {
             document.removeEventListener('keydown', window.searchModalEscListener);
             window.searchModalEscListener = null;
           }
=======
>>>>>>> 2ae0024492329e8048b1d3a48c683b39372b7919
         };

         // Odstraní všechny <mark> tagy (zvýraznění)
         function clearSearchMarks() {
           const marks = document.querySelectorAll('mark');
           marks.forEach(mark => {
             const text = document.createTextNode(mark.textContent);
             mark.replaceWith(text);
           });
         }

         // Získá všechny textové uzly kromě modal okna
         function getTextNodes(node) {
           let nodes = [];
           if (node.nodeType === Node.TEXT_NODE) {
             nodes.push(node);
           } else {
             for (let child of node.childNodes) {
               if (!(child.id && child.id === "searchModal")) {
                 nodes = nodes.concat(getTextNodes(child));
               }
             }
           }
           return nodes;
         }

         // Provede zvýraznění výskytů
         function markSearchMatches(term) {
           clearSearchMarks();
           window.matches = [];

           const nodes = getTextNodes(document.body);
           const regex = new RegExp(term, 'gi');

           nodes.forEach(node => {
             const parent = node.parentNode;
             const text = node.textContent;
             let match;
             let lastIndex = 0;
             regex.lastIndex = 0;

             if (!regex.test(text)) return;

             regex.lastIndex = 0;
             const frag = document.createDocumentFragment();

             while ((match = regex.exec(text)) !== null) {
               if (match.index > lastIndex) {
                 frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
               }
               const mark = document.createElement('mark');
               mark.textContent = match[0];
               frag.appendChild(mark);
               window.matches.push(mark);
               lastIndex = match.index + match[0].length;
             }

             if (lastIndex < text.length) {
               frag.appendChild(document.createTextNode(text.slice(lastIndex)));
             }

             parent.replaceChild(frag, node);
           });

           window.currentIndex = -1;
         }

         // Posun na další výskyt
         window.nextMatch = function () {
           const term = document.getElementById('searchTerm').value.trim();
           if (!term) return;

           if (term !== window.lastSearchTerm) {
             markSearchMatches(term);
             window.lastSearchTerm = term;
           }

           if (window.matches.length === 0) return;

           window.matches.forEach(m => m.classList.remove('current'));
           window.currentIndex = (window.currentIndex + 1) % window.matches.length;
           const current = window.matches[window.currentIndex];
           current.classList.add('current');
           current.scrollIntoView({ behavior: 'smooth', block: 'center' });

           // --- Přidá zvýraznění containeru na chvíli ---
  let container = current.closest('.device-container');
  if (container) {
    container.classList.add('highlight');
    setTimeout(() => container.classList.remove('highlight'), 1500);
  }
};

// Přidá možnost potvrdit hledání klávesou Enter
document.getElementById('searchTerm').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    window.nextMatch();
  }
});
	
      </script>
   </body>
</html>
